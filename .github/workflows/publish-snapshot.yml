name: Publish SNAPSHOT
# only publish snapshots
on:
  workflow_run:
    workflows: ["Build & Test"]
    types:
      - completed
    branches:
      - develop

# CRITICAL: Prevent parallel snapshot publishes (corrupts artifacts!)
# Only ONE snapshot publish at a time, cancel older runs
concurrency:
  group: publish-snapshot-${{ github.ref }}
  cancel-in-progress: true

permissions:
  packages: write
  contents: read

jobs:
  publish-snapshot:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Debug workflow_run context
        run: |
          echo "=== Workflow Run Context ==="
          echo "head_branch: ${{ github.event.workflow_run.head_branch }}"
          echo "head_sha: ${{ github.event.workflow_run.head_sha }}"
          echo "head_commit.id: ${{ github.event.workflow_run.head_commit.id }}"
          echo "github.ref: ${{ github.ref }}"
          echo "github.sha: ${{ github.sha }}"
          echo "event: ${{ github.event.workflow_run.event }}"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use head_sha (exact commit that was built/tested)
          ref: ${{ github.event.workflow_run.head_sha }}
      
      - name: Verify correct commit
        run: |
          echo "=== Verifying Commit ==="
          EXPECTED="${{ github.event.workflow_run.head_sha }}"
          ACTUAL=$(git rev-parse HEAD)
          echo "Expected SHA (from build): ${EXPECTED}"
          echo "Actual SHA (checked out): ${ACTUAL}"
          if [ "${ACTUAL}" != "${EXPECTED}" ]; then
            echo "❌ ERROR: Wrong commit checked out!"
            exit 1
          fi
          echo "✅ Correct commit - publishing what was tested"
        
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Extract version from gradle.properties
        id: version
        run: |
          # Handle: version=1.0.0 OR version = 1.0.0 OR version= 1.0.0
          VERSION=$(grep -E '^\s*version\s*=' gradle.properties | sed -E 's/.*=\s*//' | tr -d ' \t\n\r')
          echo "PROJECT_VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"
          
      - name: Delete existing snapshot if present
        run: |
          set -e
          VERSION="${{ steps.version.outputs.PROJECT_VERSION }}"
          
          echo "=== Checking for existing snapshot artifacts ==="
          echo "Version to check: ${VERSION}"
          
          # Known artifacts we publish (Maven package names)
          # NOTE: benchmarks, examples, load-tests are NOT published
          ARTIFACTS=(
            "de.macstab.oss.spring-redis-laned-core"
            "de.macstab.oss.spring-redis-laned-metrics"
            "de.macstab.oss.spring-redis-laned-spring-boot-3-starter"
            "de.macstab.oss.spring-redis-laned-spring-boot-4-starter"
          )
          
          DELETED_COUNT=0
          
          for PACKAGE_NAME in "${ARTIFACTS[@]}"; do
            echo ""
            echo "--- Checking artifact: ${PACKAGE_NAME} ---"
            
            # STEP 1: Check if PACKAGE/ARTIFACT exists at all
            PACKAGE_CHECK=$(curl -s -w "\n%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.BOT_GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/orgs/macstab/packages/maven/${PACKAGE_NAME}")
            
            PACKAGE_HTTP_CODE=$(echo "$PACKAGE_CHECK" | tail -n1)
            
            if [ "$PACKAGE_HTTP_CODE" = "404" ]; then
              echo "  ✓ Artifact does NOT exist yet (first publish)"
              continue
            elif [ "$PACKAGE_HTTP_CODE" != "200" ]; then
              echo "  ✗ ERROR: Failed to check artifact existence (HTTP ${PACKAGE_HTTP_CODE})"
              exit 1
            fi
            
            echo "  ✓ Artifact EXISTS in GitHub Packages"
            
            # STEP 2: Fetch versions for this artifact
            echo "  → Fetching versions..."
            VERSIONS=$(curl -s -f -H "Authorization: Bearer ${{ secrets.BOT_GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/orgs/macstab/packages/maven/${PACKAGE_NAME}/versions?per_page=100")
            
            if [ $? -ne 0 ]; then
              echo "  ✗ ERROR: Failed to fetch versions"
              exit 1
            fi
            
            # STEP 3: Check if our version exists
            VERSION_ID=$(echo "$VERSIONS" | jq -r ".[] | select(.name == \"${VERSION}\") | .id")
            
            if [ -z "$VERSION_ID" ] || [ "$VERSION_ID" = "null" ]; then
              echo "  ✓ Version ${VERSION} does NOT exist (nothing to delete)"
              continue
            fi
            
            # STEP 4: Version EXISTS - delete it
            echo "  ⚠ Version ${VERSION} EXISTS (ID: ${VERSION_ID})"
            echo "  → Deleting..."
            
            DELETE_RESULT=$(curl -s -w "\n%{http_code}" -X DELETE \
              -H "Authorization: Bearer ${{ secrets.BOT_GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/orgs/macstab/packages/maven/${PACKAGE_NAME}/versions/${VERSION_ID}")
            
            HTTP_CODE=$(echo "$DELETE_RESULT" | tail -n1)
            
            if [ "$HTTP_CODE" = "204" ]; then
              echo "  ✓ Successfully deleted"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            elif [ "$HTTP_CODE" = "404" ]; then
              echo "  ✓ Already deleted (race condition, safe)"
            else
              echo "  ✗ ERROR: Deletion failed (HTTP ${HTTP_CODE})"
              echo "$DELETE_RESULT"
              exit 1
            fi
          done
          
          echo ""
          echo "=== Cleanup complete: Deleted ${DELETED_COUNT} artifact version(s) ==="
          
      - name: Publish SNAPSHOT to GitHub Packages (skip tests - already ran in Build workflow)
        run: ./gradlew publish -x test --no-daemon --stacktrace
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
